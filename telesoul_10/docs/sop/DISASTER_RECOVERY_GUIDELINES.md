# DISASTER_RECOVERY_GUIDELINES.md

> 本文件為 TeleSoul 專案災難恢復唯一權威規範，任何修改必須經審查並記錄於 ADR 或本文件。

## 1. 目的

確保 TeleSoul 平台在出現重大故障（數據中心中斷、數據損壞、網路故障等）時，能迅速恢復業務，最大限度降低服務中斷影響與數據丟失。

## 2. 恢復目標（RTO & RPO）

* **恢復時間目標 (RTO)**：業務關鍵路徑（用戶登入、配對、通話、支付）恢復時間 ≤ 30 分鐘。
* **數據恢復點目標 (RPO)**：允許最大數據丟失 ≤ 5 分鐘。

## 3. 災備架構

1. **多可用區部署**
   * 主環境部署於 GCP 多區域 Kubernetes/GKE 節點
   * 資料庫（PostgreSQL）主從複製，讀寫分離，備節點
2. **定期備份**
   * PostgreSQL：每 5 分鐘 WAL 歸檔至 MinIO/S3，保留 7 天
   * 備份異地存儲（不同區域 S3 桶），保證故障切換可用
3. **配置與密鑰**
   * Vault/GCP Secret Manager 儲存，並異地鏡像同步

## 4. 恢復演練計劃

* **頻率**：每季度（Q1~Q4）至少一次完整演練
* **類型**：
  1. **全量恢復演練**：模擬主庫數據損壞 → 從備份恢復全量數據 → 驗證服務啟動
  2. **區域故障切換**：模擬主可用區失效 → 自動/手動切換至備可用區
  3. **WAL 應用演練**：模擬少量數據丟失 → 使用 WAL 日誌快速恢復

## 5. 演練步驟示例

1. **預演通知**：提前通知團隊，指定演練窗口
2. **故障注入**：腳本 `scripts/drill-failover.sh` 暫停主庫寫服務或關閉節點
3. **自動切換**：觸發 Kubernetes/Cloud SQL 自動故障切換，或手動 promote 備庫
4. **數據驗證**：執行核心業務腳本，驗證用戶登入、配對、通話、提領等流程
5. **全量恢復**：從最新備份恢復到新集群，驗證數據一致性與健康
6. **切回與清理**：恢復原主庫，回切流量，清理演練環境
7. **演練報告**：記錄實際 RTO/RPO、問題與改進，歸檔至 `docs/sop/drill-reports/`

## 6. 監控與告警

* **Backup Success/Failure**：每次備份完成後通知 Slack/Email
* **Replication Lag**：主從複製延遲 > 1 分鐘，觸發 PagerDuty 警報
* **Failover Events**：GCP Pub/Sub 訂閱故障切換事件，實時監控

## 7. 文檔與培訓

* 將演練流程寫入 `docs/sop/disaster_recovery.md`
* 定期組織運維與開發團隊參加 DR 演練培訓
* 演練後召開回顧會議，持續優化流程

## 8. 自動化與審查

* 災難恢復演練、備份、切換、驗證等流程應有自動化腳本（如 `scripts/drill-failover.sh`）
* 每次演練須有審查人員簽核，報告歸檔並可追溯
* CI/CD pipeline 可定期自動觸發演練腳本並生成報告

---

*End of DISASTER_RECOVERY_GUIDELINES.md* 